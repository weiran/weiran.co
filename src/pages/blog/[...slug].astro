---
import { getCollection } from 'astro:content'
import BaseLayout from '../../layouts/BaseLayout.astro'
import Bio from '../../components/Bio.astro'
import TitleLink from '../../components/TitleLink.astro'
import { formatDate } from '../../lib/text'

export async function getStaticPaths() {
  const posts = (await getCollection('blog'))
    .filter((p) => p.data.type !== 'page' && !p.data.draft)
    .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())

  return posts.map((post) => ({
    params: { slug: post.slug },
  }))
}

const slug = Astro.params.slug
if (!slug) {
  throw new Error('Missing slug param')
}

const posts = (await getCollection('blog'))
  .filter((p) => p.data.type !== 'page' && !p.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())

const entry = posts.find((p) => p.slug === slug)
if (!entry) {
  throw new Error(`Blog post not found: ${slug}`)
}

const index = posts.findIndex((p) => p.slug === slug)
const previous = index >= 0 ? posts[index + 1] : null
const next = index > 0 ? posts[index - 1] : null
const { Content } = await entry.render()
---

<BaseLayout
  title={entry.data.title}
  description={entry.data.description}
  pageType="article"
>
  <article>
    <h1>
      <TitleLink
        title={entry.data.title}
        passthroughUrl={entry.data.passthroughUrl}
        slug={entry.slug}
      />
    </h1>
    <p class="post-meta post-meta--post">{formatDate(entry.data.date)}</p>
    {entry.data.description ? <p class="post-intro">{entry.data.description}</p> : null}
    <Content />
    <p>
      <a href="/">⌘ Home</a>
    </p>
  </article>

  <Bio />

  <ul class="pager pager--posts">
    {previous ? (
      <li>
        <a href={`/blog/${previous.slug}`} rel="prev">
          ← {previous.data.title}
        </a>
      </li>
    ) : (
      <li></li>
    )}

    {next ? (
      <li>
        <a href={`/blog/${next.slug}`} rel="next">
          {next.data.title} →
        </a>
      </li>
    ) : (
      <li></li>
    )}
  </ul>
</BaseLayout>
